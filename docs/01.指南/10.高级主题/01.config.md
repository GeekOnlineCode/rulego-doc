---
title: Config
article: false
author: 
  name: rulego
  link: https://github.com/rulego/rulego
date: 2023-09-13 21:24:41
permalink: /pages/d59341/
---


规则引擎实例[Config](https://github.com/rulego/rulego/blob/main/api/types/config.go) 是一个全局配置。可以通过以下方式修改config：

```go
config := rulego.NewConfig()
ruleEngine, err := rulego.New("rule01", []byte(ruleChainFile), rulego.WithConfig(config))
```

## OnDebug

类型：`func(flowType string, nodeId string, msg RuleMsg, relationType string, err error)`
- **flowType:** IN/OUT，流入(IN)该组件或者流出(OUT)该组件事件类型
- **nodeId:** 节点ID
- **msg:** msg
- **relationType:** 如果flowType=IN，则代表上一个节点和该节点的连接关系，例如(True/False)；如果flowType=OUT，则代表该节点和下一个节点的连接关系，例如(True/False)
- **err:** 错误信息

节点调试信息回调全局函数。规则链节点配置设置`debugMode=true`后节点的In和Out过程都会触发。可以实现该接口记录调试日志，查看每个组件的执行结果。支持动态设置节点的`debugMode`字段关闭或者开启

## OnEnd

类型：`func(msg RuleMsg, err error)`
- **msg:** 结束点组件处理后的msg
- **err:** 错误信息

规则链执行完成回调全局函数，如果规则链有多个结束点，则执行多次。
例如：执行s1之后同时触发了s2、s3、s4，那么onEnd事件会触发3次，msg是分别s2、s3、s4的执行结果。规则链如下图：

![img](/img/chain/onend_example.png)

::: tip 
config配置的OnEnd函数是规则链引擎实例全局的。也可以为每条消息配置结束回调函数，使用以下方式：

```go
ruleEngine.OnMsgWithOptions(msg, types.WithEndFunc(func(msg types.RuleMsg, err error) {
    //结束回调函数 
}))
```
:::

## JsMaxExecutionTime

类型：`time.Duration`

js脚本执行超时时间，默认2000毫秒。

## Pool


类型：`types.Pool`

协程池接口，如果不配置，则使用 go func 方式。

默认使用内置的`pool.WorkerPool`。兼容ants协程池，可以使用ants协程池实现，需要自行引入对应的库。例如：

```go
pool, _ := ants.NewPool(math.MaxInt32)
config := rulego.NewConfig(types.WithPool(pool))
```

::: tip
内置的`pool.WorkerPool` 是参考了FastHttp的实现，比`ants`性能高和节省内存。
:::

## ComponentsRegistry

类型：`types.ComponentRegistry`

组件库注册器，默认使用`rulego.Registry`

## Parser

类型：`types.Parser`

规则链解析接口，默认使用：`rulego.JsonParser` ，可以实现自定义规则链DSL。

## Logger

类型：`types.Logger`

日志记录接口，默认使用：`DefaultLogger()`。[log组件](/pages/020050/) 使用该记录器。

## Properties


类型：`types.Metadata`

全局属性，key-value形式。

规则链节点配置可以通过`${global.propertyKey}`或者`${metadataKey}` 方式替换变量的内容。

- 其中`global.`为内置变量，代表从config.Properties中获取内容进行替换（节点初始化时候执行替换逻辑，只执行一次）。
- `${metadataKey}` 则从消息元数据获取内容进行替换（在节点每次处理消息时执行替换逻辑）。

> 注意：`${}`内不能出现空格。

::: tip
另外js脚本运行时也可以获取全局Properties变量值，调用方式：
```go
var value=global.propertyKey;
```
:::

使用示例参考：[node_config](https://github.com/rulego/rulego/tree/main/examples/node_config/node_config.go)

## Udf

类型：`map[string]interface{}`

注册自定义golang函数，js运行时可以通过x(param1,param2,...) 方式调用。该特性使js脚本具备调用golang函数的能力。

示例：
```go
config := rulego.NewConfig()

//在js脚本运行时获取全局变量：global.xx
config.Properties.PutValue("globalValue", "addValueFromConfig")

//注册自定义函数
config.RegisterUdf("add", func(a, b int) int {
    return a + b
})
config.RegisterUdf("handleMsg", func(msg map[string]interface{}, metadata map[string]string, msgType string) string {
    msg["returnFromGo"] = "returnFromGo"
    _, ok := rulego.Get("aa")
    msg["hasAaRuleChain"] = ok
    return "returnFromGoMsgType"
})
```
js脚本中调用：
```javascript
//调用全局配置参数
var value=global.globalValue;
msg['addField2']=value;
//调用自定义golang函数add
msg['addValue']=add(1,5); 
//调用自定义golang函数handleMsg
msgType=handleMsg(msg,metadata,msgType);
return {'msg':msg,'metadata':metadata,'msgType':msgType};
```

使用示例参考：[node_config](https://github.com/rulego/rulego/tree/main/examples/node_config/node_config.go)
