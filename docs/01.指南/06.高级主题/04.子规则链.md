---
title: 子规则链
article: false
author: 
  name: rulego
  link: https://github.com/rulego/rulego
date: 2023-09-13 21:24:41
permalink: /pages/7a6d0e/
---

规则链配置支持嵌套其他子规则链，对于复杂的规则链配置，可以通过这种嵌套方式提高规则链的可维护性和重复利用性。
例如：不同的业务创建一个子规则链，然后根规则链使用`路由节点`路由到不同子规则链进行业务处理。

![img](/img/chain/sub_chain.png)

:::center
嵌套规则链图
:::

>其中 subChain01、subChain02、subChain03、subChainN 是子规则链节点。

### 示例

定义子规则链（subChain1）配置：
```json
{
  "ruleChain": {
    "id":"subChain01",
    "name": "子规则链"
  },
  "metadata": {
    "nodes": [
      {
        "id": "sub_s1",
        "type": "jsFilter",
        "name": "过滤",
        "debugMode": true,
        "configuration": {
          "jsScript": "return msg=='aa';"
        }
      },
      {
        "id": "sub_s2",
        "type": "jsTransform",
        "name": "转换",
        "debugMode": true,
        "configuration": {
          "jsScript": "metadata['test']='Modified by sub chain';\n metadata['index']=52;\n msgType='TEST_MSG_TYPE2';var msg2={};\n  msg2['bb']=22\n return {'msg':msg2,'metadata':metadata,'msgType':msgType};"
        }
      }
    ],
    "connections": [
      {
        "fromId": "sub_s1",
        "toId": "sub_s2",
        "type": "True"
      }
    ],
    "ruleChainConnections": null
  }
}
```

定义子规则链（subChain2）配置：
```json
//省略
```

定义子规则链（subChain3）配置：
```json
//省略
```

定义子规则链（subChainN）配置：
```json
//省略
```

定义根规则链（rootRule01）配置：
```json
{
  "ruleChain": {
    "id":"rootRule01",
    "name": "测试根规则链"
  },
  "metadata": {
    "nodes": [
      {
        "id": "root_s1",
        "type": "msgTypeSwitch",
        "name": "消息路由"
      }
    ],
    "connections": [
    ],
    "ruleChainConnections": [
      {
        "fromId": "root_s1",
        "toId": "subChain01",
        "type": "MSG_TYPE1"
      },
      {
        "fromId": "root_s1",
        "toId": "subChain02",
        "type": "MSG_TYPE2"
      },
      {
        "fromId": "root_s1",
        "toId": "subChain03",
        "type": "MSG_TYPE3"
      },
      {
        "fromId": "root_s1",
        "toId": "subChainN",
        "type": "MSG_TYPE_N"
      }
    ]
  }
}
```

始化子规则链和根规则链：
```go
    //初始化子规则链
	subRuleEngine1, err := New("subChain01", []byte(subRuleChain01Fille), WithConfig(config))
	subRuleEngine2, err := New("subChain02", []byte(subRuleChain02Fille), WithConfig(config))
	subRuleEngine3, err := New("subChain03", []byte(subRuleChain03Fille), WithConfig(config))
	subRuleEngineN, err := New("subChainN", []byte(subRuleChainNFille), WithConfig(config))
	//初始化根规则链
	ruleEngine, err := New("rootRule01", []byte(rootRuleChain), WithConfig(config))
```

处理消息：
```go
ruleEngine.OnMsg(msg)
```
